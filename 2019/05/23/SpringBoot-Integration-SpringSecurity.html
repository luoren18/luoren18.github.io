<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring Boot 集成 Spring Security - REN博客</title>
    <meta name="author"  content="REN">
    <meta name="description" content="Spring Boot 集成 Spring Security">
    <meta name="keywords"  content="java, Spring">
    <!-- Open Graph -->
    <meta property="og:title" content="Spring Boot 集成 Spring Security - REN博客">
    <meta property="og:type" content="website">
    <meta property="og:url" content="http://localhost:4000/2019/05/23/SpringBoot-Integration-SpringSecurity.html">
    <meta property="og:description" content="个人博客,REN博客,JAVA,PYTHON,JEKYLL,JAVA程序员,JAVA程序猿,后台开发。">
    <meta property="og:site_name" content="REN博客">
    <link rel="stylesheet" href="//cdn.staticfile.org/normalize/6.0.0/normalize.min.css">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_roc50gemkxpw4s4i.css">
    <link rel="stylesheet" href="/assets/css/github-markdown.css">
    <link rel="stylesheet" href="/assets/css/prism.css">
    <link rel="stylesheet" href="/assets/css/share.min.css">
    <link rel="stylesheet" href="/assets/css/app.min.css">
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    
    <script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
	
	<!--
Author: Ray-Eldath
refer to:
 - http://docs.mathjax.org/en/latest/options/index.html
-->

	<script type="text/javascript" async src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
	
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
		jax: ["input/TeX", "output/HTML-CSS"],
		tex2jax: {
			inlineMath: [ ["$", "$"] ],
			displayMath: [ ["$$", "$$"] ],
			skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
		},
		"HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
      });
    </script>

	
    <!--
Author: Ray-Eldath
-->
<style>
    .markdown-body .anchor{
        float: left;
        margin-top: -8px;
        margin-left: -20px;
        padding-right: 4px;
        line-height: 1;
        opacity: 0;
    }
    
    .markdown-body .anchor .anchor-icon{
        font-size: 15px
    }
</style>
<script>
    $(document).ready(function() {
        let nodes = document.querySelector(".markdown-body").querySelectorAll("h1,h2,h3")
        for(let node of nodes) {
            var anchor = document.createElement("a")
            var anchorIcon = document.createElement("i")
            anchorIcon.setAttribute("class", "fa fa-anchor fa-lg anchor-icon")
            anchorIcon.setAttribute("aria-hidden", true)
            anchor.setAttribute("class", "anchor")
            anchor.setAttribute("href", "#" + node.getAttribute("id"))
            
            anchor.onmouseover = function() {
                this.style.opacity = "0.4"
            }
            
            anchor.onmouseout = function() {
                this.style.opacity = "0"
            }
            
            anchor.appendChild(anchorIcon)
            node.appendChild(anchor)
        }
    })
</script>
</head>


<body>
  <!--[if lt IE 10]>
<div class="alert-danger" role="alert">你的浏览器实在太太太旧了，放学别走，升级完浏览器再说！<a target="_blank" class="alert-link" href="http://browsehappy.com">立即升级</a></div>
<![endif]-->
  <input id="nm-switch" type="hidden" value="true"> <header class="g-header">
    <div class="g-logo">
      <a href="/"></a>
    </div>
    <i id="menu-toggle" class="iconfont icon-menu"></i>
    <nav class="g-nav">
        <ul>
            
            <li><a href="/">home</a></li>
            
            <li><a href="/tags.html">tags</a></li>
            
            <li><a href="/rss.xml" target="_blank">RSS</a></li>
            <li><a href="https://wangchujiang.com/linux-command/" target="_blank">COMMAND LINUX</a></li>
        </ul>
    </nav>
</header>


  <header
    class="g-banner post-header post-pattern-overlappingCircles bgcolor-default "
    data-theme="default">
    <div class="post-wrapper">
      <div class="post-tags">
        
        
        <a href=/tags.html#java class="post-tag">java</a>
        
        <a href=/tags.html#Spring class="post-tag">Spring</a>
        
        
      </div>
      <h1>Spring Boot 集成 Spring Security</h1>
      <div class="post-meta">
        <span class="post-meta-item"><i
            class="iconfont icon-author"></i>luoren</span>
        <time class="post-meta-item" datetime="19-05-23"><i
            class="iconfont icon-date"></i>23 May 2019</time>
      </div>
    </div>
    
    <div class="filter"></div>
    <div class="post-cover" style="background: url('http://noteimg.luoren.top/markdown_img/20190524153323.png') center no-repeat; background-size: cover;"></div>
    
  </header>

  <div class="post-content visible">
    
    <h2 class="post-subtitle">Spring Security</h2>
    

    <article class="markdown-body">
      <h2 id="一spring-security-核心概念">一、Spring Security 核心概念</h2>

<ul>
  <li>
    <p><strong><em>AuthenticationManager</em></strong>，用户认证管理类，所有的认证请求(比如login)都会通过提交一个token 给AuthenticationManager 的authenticate()方法来实现。具体的校验动作会由AuthenticationManager 将请求转发给具体的实现类来做。</p>
  </li>
  <li>
    <p><strong><em>AuthenticationProvider</em></strong>，认证的具体实现类，一个provider是一种认证方式的实现。比如将用户名密码和DB作比较实现的就有一个DBProvider ,如果是通过CAS请求单点登录系统实现，就会有一个CASProvider。SpringSecurity默认实现了DAO、LDAP、CAS、OAuth2 。</p>

    <p>上面讲了<code class="highlighter-rouge">AuthenticationManager</code>只是一个代理接口，真正的认知是由<code class="highlighter-rouge">AuthenticationProvider</code> 来做。一个<code class="highlighter-rouge">Manager</code> 可以包含多个<code class="highlighter-rouge">Provider</code>，每个<code class="highlighter-rouge">provider</code>通过实现一个<code class="highlighter-rouge">support</code>方法来表示自己支持那种Token的认证。<code class="highlighter-rouge">AuthenticationManager</code>默认的实现类是<code class="highlighter-rouge">ProviderManager</code>。</p>
  </li>
  <li>
    <p><strong><em>UserDetails</em></strong>，代表了Spring Security的用户实体类，带有用户名、密码、权限特性等性质，可以自己实现该接口，供 Spring Security 安全认证使用，Spring Security 默认使用的是内置的 User 类；将从数据库获取的 User 对象传入实现该接口的类，并获取 User 对象的值来让类实现该接口的方法；通过 <code class="highlighter-rouge">Authentication.getPrincipal()</code> 的返回类型是 Object，但很多情况下其返回的其实是一个 UserDetails 的实例。</p>
  </li>
  <li>
    <p><strong><em>UserDetailService</em></strong>, 用户认证通过Provider来做，所以Provider需要拿到系统已经保存的认证信息，获取用户信息的接口spring-security抽象成<code class="highlighter-rouge">UserDetailService</code>。</p>
  </li>
  <li>
    <p><strong><em>AuthenticationToken</em></strong>,  所有提交给<code class="highlighter-rouge">AuthenticationManager</code>的认证请求都会被封装成一个Token的实现，比如最容易理解的<code class="highlighter-rouge">UsernamePasswordAuthenticationToken</code>。</p>
  </li>
  <li>
    <p><strong><em>SecurityContext</em></strong>，当用户通过认证之后，就会为这个用户生成一个唯一的<code class="highlighter-rouge">SecurityContext</code>，里面包含用户的认证信息<code class="highlighter-rouge">Authentication</code>。通过SecurityContext我们可以获取到用户的标识<code class="highlighter-rouge">Principle</code>和授权信息<code class="highlighter-rouge">GrantedAuthrity</code>。在系统的任何地方只要通过<code class="highlighter-rouge">SecurityHolder.getSecruityContext()</code>就可以获取到<code class="highlighter-rouge">SecurityContext</code>。</p>
  </li>
</ul>

<p><img src="http://noteimg.luoren.top/markdown_img/20190508095355.jpg" alt="" /></p>

<h2 id="二前后端分离jwt认证的实现">二、前后端分离+JWT认证的实现</h2>

<p>需求：</p>

<ul>
  <li>支持用户通过用户名和密码登录</li>
  <li>登录后通过http header返回token，每次请求，客户端需通过header将token带回，用于权限校验</li>
  <li>对于认证失败和权限校验失败做出统一的处理</li>
</ul>

<h3 id="1一切从实体类开始">1、一切从实体类开始</h3>

<h4 id="user类"><strong>User类</strong></h4>

<p>Spring Security 提供了UserDetails接口，实现它。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="kd">implements</span> <span class="n">UserDetails</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">age</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">enabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Role</span><span class="o">&gt;</span> <span class="n">roles</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">User</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">User</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">username</span> <span class="o">=</span> <span class="n">username</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">password</span> <span class="o">=</span> <span class="n">password</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="nd">@JsonIgnore</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">getAuthorities</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">roles</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">map</span><span class="o">(</span><span class="n">role</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">SimpleGrantedAuthority</span><span class="o">(</span><span class="n">role</span><span class="o">.</span><span class="na">getName</span><span class="o">())).</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toSet</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="cm">/**
     * 账户是否过期
     *
     * @return
     */</span>
    <span class="nd">@JsonIgnore</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isAccountNonExpired</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 账户是否被锁定
     *
     * @return
     */</span>
    <span class="nd">@JsonIgnore</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isAccountNonLocked</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 用户凭证是否过期
     *
     * @return
     */</span>
    <span class="nd">@JsonIgnore</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isCredentialsNonExpired</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isEnabled</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">enabled</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>UserDetails 中提供了一个   <code class="highlighter-rouge">Collection&lt;? extends GrantedAuthority&gt; getAuthorities(); </code> 它是用来获取用户角色的。</p>

<h4 id="role-角色类"><strong>Role (角色类）</strong></h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Role</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">cname</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="menu资源类"><strong>Menu(资源类)</strong></h4>

<pre><code class="language-java ">@Data
public class Menu {
    private int id;
    private String url;
    private String path;
    private String component;
    private String name;
    private String iconCls;
    private int parentId;
    @JsonIgnore
    private List&lt;Role&gt; roles;
    private boolean enabled;
}
</code></pre>

<h3 id="2重点讲一个serviceuserservice">2.重点讲一个Service:UserService</h3>

<p>Spring Security 提供了一个UserDetailsService 接口，其中只提供了一个方法<code class="highlighter-rouge">UserDetails loadUserByUsername(String username) throws UsernameNotFoundException;</code>在Spring Security 校验过程中，会通过这个方法获取用户信息。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">UsernameNotFoundException</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="kt">boolean</span> <span class="n">isExistInRedis</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">username</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">userRedisService</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">REDIS_KEY_PREFIX</span> <span class="o">+</span> <span class="n">username</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">ObjectUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">user</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">isExistInRedis</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">baseMapper</span><span class="o">.</span><span class="na">loadUserByUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ObjectUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">user</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"用户："</span> <span class="o">+</span> <span class="n">username</span> <span class="o">+</span> <span class="s">" 不存在."</span><span class="o">);</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">UsernameNotFoundException</span><span class="o">(</span><span class="s">"用户不存在"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">isExistInRedis</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">userRedisService</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">REDIS_KEY_PREFIX</span> <span class="o">+</span> <span class="n">username</span><span class="o">,</span> <span class="n">user</span><span class="o">,</span> <span class="n">USER_EXPIRE_TIME</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>代码逻辑大概就是这样，我是引入了redis做用户信息缓存 ，不需要的可以忽略。</p>

<h3 id="3最核心的配置类websecurityconfigureradapter">3.最核心的配置类WebSecurityConfigurerAdapter</h3>

<p>WebSecurityConfigurerAdapter 是一个抽象类，可以通过重写他的方法自定一些实现，比如认证授权的异常处理，自定义的权限认证，自定义过滤器，自定义密码的加密规则等等。</p>

<p>下面是我的自定义<strong><em>WebSecurityConfig</em></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@EnableGlobalMethodSecurity</span><span class="o">(</span><span class="n">prePostEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="nd">@EnableWebSecurity</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebSecurityConfig</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserService</span> <span class="n">userService</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="n">CustomAccessDeniedHandler</span> <span class="n">customAccessDeniedHandler</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="n">CustomAuthenticationEntryPoint</span> <span class="n">unauthorizedHandler</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="n">CaptchaFilter</span> <span class="n">captchaFilter</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="n">JwtAuthenticationTokenFilter</span> <span class="n">jwtAuthenticationTokenFilter</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="n">CustomMetadataSource</span> <span class="n">metadataSource</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="n">CustomAccessDecisionManager</span> <span class="n">accessDecisionManager</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">auth</span><span class="o">.</span><span class="na">userDetailsService</span><span class="o">(</span><span class="n">userService</span><span class="o">).</span><span class="na">passwordEncoder</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>

        <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">().</span><span class="na">withObjectPostProcessor</span><span class="o">(</span><span class="k">new</span> <span class="n">ObjectPostProcessor</span><span class="o">&lt;</span><span class="n">FilterSecurityInterceptor</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="cm">/**
             * 自定义用户权限处理
             * @param object
             * @param &lt;O&gt;
             * @return
             */</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="o">&lt;</span><span class="n">O</span> <span class="kd">extends</span> <span class="n">FilterSecurityInterceptor</span><span class="o">&gt;</span> <span class="n">O</span> <span class="nf">postProcess</span><span class="o">(</span><span class="n">O</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">object</span><span class="o">.</span><span class="na">setSecurityMetadataSource</span><span class="o">(</span><span class="n">metadataSource</span><span class="o">);</span>
                <span class="n">object</span><span class="o">.</span><span class="na">setAccessDecisionManager</span><span class="o">(</span><span class="n">accessDecisionManager</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">object</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="c1">//</span>
        <span class="n">http</span><span class="o">.</span><span class="na">exceptionHandling</span><span class="o">()</span>
                <span class="c1">//认证授权异常处理</span>
                <span class="o">.</span><span class="na">accessDeniedHandler</span><span class="o">(</span><span class="n">customAccessDeniedHandler</span><span class="o">)</span>
                <span class="o">.</span><span class="na">authenticationEntryPoint</span><span class="o">(</span><span class="n">unauthorizedHandler</span><span class="o">)</span>
                <span class="o">.</span><span class="na">and</span><span class="o">().</span><span class="na">csrf</span><span class="o">().</span><span class="na">disable</span><span class="o">()</span><span class="c1">//关闭csrf</span>
                <span class="o">.</span><span class="na">cors</span><span class="o">().</span><span class="na">disable</span><span class="o">()</span>
                <span class="c1">//前后端分离，JWT 认证，关闭session</span>
                <span class="o">.</span><span class="na">sessionManagement</span><span class="o">().</span><span class="na">sessionCreationPolicy</span><span class="o">(</span><span class="n">SessionCreationPolicy</span><span class="o">.</span><span class="na">STATELESS</span><span class="o">)</span>
                <span class="o">.</span><span class="na">and</span><span class="o">()</span>
                <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span><span class="c1">//权限配置</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/authentication/**"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                <span class="o">.</span><span class="na">anyRequest</span><span class="o">()</span><span class="c1">//所有请求</span>
                <span class="o">.</span><span class="na">authenticated</span><span class="o">()</span><span class="c1">//都需要认证</span>
                <span class="o">.</span><span class="na">and</span><span class="o">().</span><span class="na">headers</span><span class="o">().</span><span class="na">cacheControl</span><span class="o">();</span><span class="c1">// 禁用缓存</span>
        <span class="c1">//添加验证码过滤器，JWT 过滤器</span>
        <span class="n">http</span><span class="o">.</span><span class="na">addFilterBefore</span><span class="o">(</span><span class="n">captchaFilter</span><span class="o">,</span> <span class="n">UsernamePasswordAuthenticationFilter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">http</span><span class="o">.</span><span class="na">addFilterBefore</span><span class="o">(</span><span class="n">jwtAuthenticationTokenFilter</span><span class="o">,</span> <span class="n">UsernamePasswordAuthenticationFilter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="cm">/**
     * 使用BCrypt的强散列哈希加密实现，并可以由客户端指定加密的强度strength，强度越高安全性自然就越高，默认为10.
     *
     * @return
     */</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">BCryptPasswordEncoder</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">AuthenticationManager</span> <span class="nf">authenticationManagerBean</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">authenticationManagerBean</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>从上往下开始理：</p>

<h4 id="enableglobalmethodsecurityprepostenabled--true"><strong><em>@EnableGlobalMethodSecurity(prePostEnabled = true)</em></strong></h4>

<p>Spring Security默认是禁用注解的，要想开启注解，需要在继承WebSecurityConfigurerAdapter的类上加@EnableGlobalMethodSecurity注解，来判断用户对某个控制层的方法是否具有访问权限。</p>

<h4 id="enablewebsecurity"><strong><em>@EnableWebSecurity</em></strong></h4>

<p>在springboot项目中启用Spring Security</p>

<h4 id="configuration"><strong><em>@Configuration</em></strong></h4>

<p>表示这是一个配置类</p>

<h4 id="configureauthenticationmanagerbuilder-auth"><strong><em>configure(AuthenticationManagerBuilder auth)</em></strong></h4>

<p>在里面配置了userService和密码的加密规则<code class="highlighter-rouge">passwordEncoder()</code>，用户用户认证</p>

<p><code class="highlighter-rouge">passwordEncoder()</code>返回一个<strong>BCryptPasswordEncoder</strong>：它是PasswordEncoder的实现，它使用BCrypt强哈希函数。客户端可以选择性地提供“强度”（在BCrypt中的a.k.a.log轮次）和SecureRandom 实例。强度参数越大，需要做的工作就越多（以指数方式）来散列密码。默认值为10。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
     * 使用BCrypt的强散列哈希加密实现，并可以由客户端指定加密的强度strength，强度越高安全性自然就越高，默认为10.
     *
     * @return
     */</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">BCryptPasswordEncoder</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div></div>

<h4 id="configurehttpsecurity-http"><strong><em>configure(HttpSecurity http)</em></strong></h4>

<h5 id="1自定义用户权限处理">1.自定义用户权限处理</h5>

<p><img src="http://noteimg.luoren.top/markdown_img/20190524103014.png" alt="" /></p>

<p><code class="highlighter-rouge">metadataSource</code>的具体实现如下，它的目的是返回可以访问该接口的角色。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomMetadataSource</span> <span class="kd">implements</span> <span class="n">FilterInvocationSecurityMetadataSource</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="n">MenuMapper</span> <span class="n">menuMapper</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">AntPathMatcher</span> <span class="n">antPathMatcher</span><span class="o">=</span><span class="k">new</span> <span class="n">AntPathMatcher</span><span class="o">();</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">ConfigAttribute</span><span class="o">&gt;</span> <span class="nf">getAttributes</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IllegalArgumentException</span> <span class="o">{</span>
        <span class="n">FilterInvocation</span> <span class="n">invocation</span><span class="o">=</span> <span class="o">(</span><span class="n">FilterInvocation</span><span class="o">)</span> <span class="n">object</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">path</span><span class="o">=</span><span class="n">invocation</span><span class="o">.</span><span class="na">getRequestUrl</span><span class="o">();</span>
        <span class="n">Set</span><span class="o">&lt;</span><span class="n">Menu</span><span class="o">&gt;</span> <span class="n">menus</span><span class="o">=</span>  <span class="n">menuMapper</span><span class="o">.</span><span class="na">getAllMenu</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Menu</span> <span class="nl">menu:</span><span class="n">menus</span><span class="o">){</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">antPathMatcher</span><span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">menu</span><span class="o">.</span><span class="na">getUrl</span><span class="o">(),</span><span class="n">path</span><span class="o">)&amp;&amp;</span> <span class="n">menu</span><span class="o">.</span><span class="na">getRoles</span><span class="o">().</span><span class="na">size</span><span class="o">()&gt;</span><span class="mi">0</span><span class="o">){</span>
                <span class="k">return</span> <span class="n">SecurityConfig</span><span class="o">.</span><span class="na">createList</span><span class="o">(</span><span class="n">menu</span><span class="o">.</span><span class="na">getRoles</span><span class="o">().</span><span class="na">stream</span><span class="o">().</span><span class="na">map</span><span class="o">(</span><span class="nl">Role:</span><span class="o">:</span><span class="n">getName</span><span class="o">).</span><span class="na">toArray</span><span class="o">(</span><span class="n">String</span><span class="o">[]::</span><span class="k">new</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">SecurityConfig</span><span class="o">.</span><span class="na">createList</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">ConfigAttribute</span><span class="o">&gt;</span> <span class="nf">getAllConfigAttributes</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">supports</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">FilterInvocation</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">accessDecisionManager</code>的具体实现如下，它的目的是判断用户是否拥有当前请求所需要的权限</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomAccessDecisionManager</span> <span class="kd">implements</span> <span class="n">AccessDecisionManager</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">decide</span><span class="o">(</span><span class="n">Authentication</span> <span class="n">authentication</span><span class="o">,</span> <span class="n">Object</span> <span class="n">object</span><span class="o">,</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">ConfigAttribute</span><span class="o">&gt;</span> <span class="n">configAttributes</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">AccessDeniedException</span><span class="o">,</span> <span class="n">InsufficientAuthenticationException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">CollectionUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">configAttributes</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">grantedAuthorities</span> <span class="o">=</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">ConfigAttribute</span> <span class="nl">configAttribute:</span><span class="n">configAttributes</span><span class="o">){</span>
            <span class="kt">boolean</span> <span class="n">flag</span><span class="o">=</span><span class="n">grantedAuthorities</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">map</span><span class="o">(</span><span class="nl">GrantedAuthority:</span><span class="o">:</span><span class="n">getAuthority</span><span class="o">).</span><span class="na">anyMatch</span><span class="o">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">configAttribute</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">()));</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">flag</span><span class="o">){</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">AccessDeniedException</span><span class="o">(</span><span class="s">"不允许访问"</span><span class="o">);</span>

    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">supports</span><span class="o">(</span><span class="n">ConfigAttribute</span> <span class="n">attribute</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">supports</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="2认证授权异常处理">2.认证授权异常处理</h5>

<p><img src="http://noteimg.luoren.top/markdown_img/20190524105421.png" alt="" /></p>

<p><code class="highlighter-rouge">customAccessDeniedHandler</code>的具体实现如下，它的目的是处理权限不足时权限认证时的异常</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomAccessDeniedHandler</span> <span class="kd">implements</span> <span class="n">AccessDeniedHandler</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">Gson</span> <span class="n">gson</span><span class="o">;</span>

    <span class="cm">/**
     * 登录状态下，权限不足时执行该方法
     *
     * @param request
     * @param response
     * @param accessDeniedException
     * @throws IOException
     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">AccessDeniedException</span> <span class="n">accessDeniedException</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span>  <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"权限不足："</span> <span class="o">+</span> <span class="n">accessDeniedException</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">.</span><span class="na">value</span><span class="o">());</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setCharacterEncoding</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"application/json;charset=utf-8"</span><span class="o">);</span>
        <span class="n">PrintWriter</span> <span class="n">out</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">();</span>
        <span class="n">RespBody</span> <span class="n">respBody</span> <span class="o">=</span> <span class="n">RespBody</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"权限不足，"</span> <span class="o">+</span> <span class="n">accessDeniedException</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="n">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">gson</span><span class="o">.</span><span class="na">toJson</span><span class="o">(</span><span class="n">respBody</span><span class="o">));</span>
        <span class="n">out</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
        <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">unauthorizedHandler</code>的具体实现如下，认证失败的异常处理</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomAuthenticationEntryPoint</span> <span class="kd">implements</span> <span class="n">AuthenticationEntryPoint</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="n">Gson</span> <span class="n">gson</span><span class="o">;</span>
    <span class="cm">/**
     * 验证为未登录状态是会执行此方法，认证失败
     *
     * @param request
     * @param response
     * @param authException
     * @throws IOException
     * @throws ServletException
     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">commence</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">AuthenticationException</span> <span class="n">authException</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"认证失败："</span> <span class="o">+</span> <span class="n">authException</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">.</span><span class="na">value</span><span class="o">());</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setCharacterEncoding</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"application/json; charset=utf-8"</span><span class="o">);</span>
        <span class="n">PrintWriter</span> <span class="n">out</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">();</span>
        <span class="n">RespBody</span> <span class="n">respBody</span> <span class="o">=</span> <span class="n">RespBody</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"认证失败,"</span><span class="o">+</span><span class="n">authException</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="n">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">gson</span><span class="o">.</span><span class="na">toJson</span><span class="o">(</span><span class="n">respBody</span><span class="o">));</span>
        <span class="n">out</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
        <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="3认证配置">3.认证配置</h5>

<p><img src="http://noteimg.luoren.top/markdown_img/20190524112349.png" alt="" /></p>

<h5 id="4自定义filter">4.自定义filter</h5>

<p>JWT Filter,代码如下</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JwtAuthenticationTokenFilter</span> <span class="kd">extends</span> <span class="n">OncePerRequestFilter</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="n">JwtTokenUtil</span> <span class="n">tokenUtil</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="n">UserService</span> <span class="n">userService</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="n">CustomAuthenticationEntryPoint</span> <span class="n">authenticationEntryPoint</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doFilterInternal</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">httpServletRequest</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">httpServletResponse</span><span class="o">,</span> <span class="n">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">httpServletRequest</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="n">JwtConst</span><span class="o">.</span><span class="na">HEADER_STRING</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">validateToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IdentityAuthException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">authenticationEntryPoint</span><span class="o">.</span><span class="na">commence</span><span class="o">(</span><span class="n">httpServletRequest</span><span class="o">,</span> <span class="n">httpServletResponse</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">tokenUtil</span><span class="o">.</span><span class="na">getUsernameFromToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">username</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">getAuthentication</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">UserDetails</span> <span class="n">userDetails</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">loadUserByUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
            <span class="n">UsernamePasswordAuthenticationToken</span> <span class="n">authentication</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UsernamePasswordAuthenticationToken</span><span class="o">(</span>
                    <span class="n">userDetails</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">userDetails</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">());</span>
            <span class="n">authentication</span><span class="o">.</span><span class="na">setDetails</span><span class="o">(</span><span class="k">new</span> <span class="n">WebAuthenticationDetailsSource</span><span class="o">().</span><span class="na">buildDetails</span><span class="o">(</span>
                    <span class="n">httpServletRequest</span><span class="o">));</span>
            <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">setAuthentication</span><span class="o">(</span><span class="n">authentication</span><span class="o">);</span>
            <span class="n">httpServletRequest</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"username"</span><span class="o">,</span> <span class="n">username</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">httpServletRequest</span><span class="o">,</span> <span class="n">httpServletResponse</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">validateToken</span><span class="o">(</span><span class="n">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">token</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">tokenUtil</span><span class="o">.</span><span class="na">getUsernameFromToken</span><span class="o">(</span><span class="n">token</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IdentityAuthException</span><span class="o">(</span><span class="s">"无效的token"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">tokenUtil</span><span class="o">.</span><span class="na">isTokenExpired</span><span class="o">(</span><span class="n">token</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IdentityAuthException</span><span class="o">(</span><span class="s">"过期的token"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>JwtTokenUtil,代码如下</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Data</span>
<span class="nd">@Component</span>
<span class="nd">@ConfigurationProperties</span><span class="o">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="s">"jwt"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JwtTokenUtil</span> <span class="o">{</span>
    <span class="cm">/**
     * 从数据声明生成令牌
     *
     * @param claims 数据声明
     * @return 令牌
     */</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="nf">generateToken</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">claims</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Date</span> <span class="n">expirationDate</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">+</span> <span class="n">JwtConst</span><span class="o">.</span><span class="na">EXPIRATION_TIME</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">Jwts</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">setClaims</span><span class="o">(</span><span class="n">claims</span><span class="o">).</span><span class="na">setExpiration</span><span class="o">(</span><span class="n">expirationDate</span><span class="o">).</span><span class="na">signWith</span><span class="o">(</span><span class="n">SignatureAlgorithm</span><span class="o">.</span><span class="na">HS512</span><span class="o">,</span> <span class="n">JwtConst</span><span class="o">.</span><span class="na">SECRET</span><span class="o">).</span><span class="na">compact</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 从令牌中获取数据声明
     *
     * @param token 令牌
     * @return 数据声明
     */</span>
    <span class="kd">private</span> <span class="n">Claims</span> <span class="nf">getClaimsFromToken</span><span class="o">(</span><span class="n">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Claims</span> <span class="n">claims</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">claims</span> <span class="o">=</span> <span class="n">Jwts</span><span class="o">.</span><span class="na">parser</span><span class="o">().</span><span class="na">setSigningKey</span><span class="o">(</span><span class="n">JwtConst</span><span class="o">.</span><span class="na">SECRET</span><span class="o">).</span><span class="na">parseClaimsJws</span><span class="o">(</span><span class="n">token</span><span class="o">).</span><span class="na">getBody</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">claims</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">claims</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 生成令牌
     *
     * @param userDetails 用户
     * @return 令牌
     */</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">generateToken</span><span class="o">(</span><span class="n">UserDetails</span> <span class="n">userDetails</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">claims</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;(</span><span class="mi">2</span><span class="o">);</span>
        <span class="n">claims</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">Claims</span><span class="o">.</span><span class="na">SUBJECT</span><span class="o">,</span> <span class="n">userDetails</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
        <span class="n">claims</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">Claims</span><span class="o">.</span><span class="na">ISSUED_AT</span><span class="o">,</span> <span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
        <span class="k">return</span> <span class="nf">generateToken</span><span class="o">(</span><span class="n">claims</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 从令牌中获取用户名
     *
     * @param token 令牌
     * @return 用户名
     */</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getUsernameFromToken</span><span class="o">(</span><span class="n">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">username</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Claims</span> <span class="n">claims</span> <span class="o">=</span> <span class="n">getClaimsFromToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">claims</span><span class="o">.</span><span class="na">getSubject</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">username</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">username</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 判断令牌是否过期
     *
     * @param token 令牌
     * @return 是否过期
     */</span>
    <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">isTokenExpired</span><span class="o">(</span><span class="n">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Claims</span> <span class="n">claims</span> <span class="o">=</span> <span class="n">getClaimsFromToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
            <span class="n">Date</span> <span class="n">expiration</span> <span class="o">=</span> <span class="n">claims</span><span class="o">.</span><span class="na">getExpiration</span><span class="o">();</span>
            <span class="k">return</span> <span class="n">expiration</span><span class="o">.</span><span class="na">before</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 刷新令牌
     *
     * @param token 原令牌
     * @return 新令牌
     */</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">refreshToken</span><span class="o">(</span><span class="n">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">refreshedToken</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Claims</span> <span class="n">claims</span> <span class="o">=</span> <span class="n">getClaimsFromToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
            <span class="n">claims</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">Claims</span><span class="o">.</span><span class="na">ISSUED_AT</span><span class="o">,</span> <span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
            <span class="n">refreshedToken</span> <span class="o">=</span> <span class="n">generateToken</span><span class="o">(</span><span class="n">claims</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">refreshedToken</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">refreshedToken</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 验证令牌
     *
     * @param token       令牌
     * @param userDetails 用户
     * @return 是否有效
     */</span>
    <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">validateToken</span><span class="o">(</span><span class="n">String</span> <span class="n">token</span><span class="o">,</span> <span class="n">UserDetails</span> <span class="n">userDetails</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">getUsernameFromToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">username</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">userDetails</span><span class="o">.</span><span class="na">getUsername</span><span class="o">())</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isTokenExpired</span><span class="o">(</span><span class="n">token</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="4登录认证逻辑">4.登录认证逻辑</h3>

<p>userService.userLogin(username, password);</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Autowired</span>
<span class="n">AuthenticationManager</span> <span class="n">authenticationManager</span><span class="o">;</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">userLogin</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">Authentication</span> <span class="n">authentication</span> <span class="o">=</span><span class="n">authentication</span><span class="o">(</span><span class="n">username</span><span class="o">,</span><span class="n">password</span><span class="o">);</span>
    <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">setAuthentication</span><span class="o">(</span><span class="n">authentication</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">UserDetails</span> <span class="n">userDetails</span> <span class="o">=</span> <span class="o">(</span><span class="n">UserDetails</span><span class="o">)</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span>
    <span class="kd">final</span> <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">tokenUtil</span><span class="o">.</span><span class="na">generateToken</span><span class="o">(</span><span class="n">userDetails</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">getAuthentication</span><span class="o">());</span>
    <span class="k">return</span> <span class="n">token</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="n">Authentication</span> <span class="nf">authentication</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">authenticationManager</span><span class="o">.</span><span class="na">authenticate</span><span class="o">(</span><span class="k">new</span> <span class="n">UsernamePasswordAuthenticationToken</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">DisabledException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">CustomException</span><span class="o">(</span><span class="s">"账户未激活"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">BadCredentialsException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">CustomException</span><span class="o">(</span><span class="s">"用户名或密码错误"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">LockedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">CustomException</span><span class="o">(</span><span class="s">"账户被锁定"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>也就是说，把具体用户名密码校验的逻辑交给SpringSecurity来处理，校验通过便将认证信息存入<code class="highlighter-rouge">SecurityContextHolder.getContext()</code>,由SpringSecurity 完成权限校验。</p>

<h2 id="三数据库的设计">三、数据库的设计</h2>

<p><img src="http://noteimg.luoren.top/markdown_img/20190524145929.png" alt="" /></p>

<h2 id="四项目地址">四、项目地址</h2>

<p><a href="https://github.com/luoren18/sys-core-module.git">https://github.com/luoren18/sys-core-module.git</a></p>


    </article>

    
    <div class="social-share-wrapper">
      <div class="social-share"></div>
    </div>
    
  </div>

  <section class="author-detail">
    <section class="post-footer-item author-card">
      <div class="avatar">
        <!-- <img src="http://noteimg.luoren.top/markdown_img/20190428084026.png" alt=""> -->
        <img src="http://noteimg.luoren.top/markdown_img/20190428084026.png" alt="">
      </div>
      <div class="author-name" rel="author">REN</div>
      <div class="bio">
        <p>码农，JAVA程序员，爱下厨，假装热爱技术&生活稍微过过也能活下去，哪有那么多要求</p>
      </div>
      
      <ul class="sns-links">
        
        <li>
          <a href="//weibo.com/lawren18" target="_blank">
            <i class="iconfont icon-weibo"></i>
          </a>
        </li>
        
        <li>
          <a href="mailto:luoren96@gmail.com" target="_blank">
            <i class="iconfont icon-email"></i>
          </a>
        </li>
        
        <li>
          <a href="//twitter.com/kaiorren" target="_blank">
            <i class="iconfont icon-twitter"></i>
          </a>
        </li>
        
        <li>
          <a href="//github.com/luoren18" target="_blank">
            <i class="iconfont icon-github"></i>
          </a>
        </li>
        
      </ul>
      
    </section>
    <section class="post-footer-item read-next">
      
      <div class="read-next-item">
        <a href="/2019/07/17/%E9%97%AE%E4%BD%A0.html" class="read-next-link"></a>
        <section>
          <span>问你</span>
          <p>《问你》</p>
        </section>
        
      </div>
      

      
      <div class="read-next-item">
        <a href="/2019/04/23/getmtime-and-getctime.html" class="read-next-link"></a>
        <section>
          <span>os.path.getmtime与os.path.getctime的区别</span>
          <p>import osimport timefile='/Volumes/Leopard/Users/Caroline...</p>
        </section>
        
      </div>
      
    </section>
    
    <section class="post-footer-item comment">
      <!-- <div id="disqus_thread"></div> -->
      <div id="gitalk-container"></div>
    </section>
    <!-- <div id="gitalk-container"></div> -->
    
  </section>

  <footer class="g-footer">
  <section>REN博客 ©
  
  
  2019
  </section>
  <section>Powered by <a href="//jekyllrb.com">Jekyll</a> | <a href="https://github.com/kaeyleo/jekyll-theme-H2O">Theme H2O</a></section>
</footer>


  <script src="/assets/js/social-share.min.js"></script>
  <script>
      socialShare('.social-share', {
        sites: [
          
            'wechat'
            ,
            
          
            'weibo'
            ,
            
          
            'douban'
            ,
            
          
            'twitter'
            
          
        ],
        wechatQrcodeTitle: "分享到微信朋友圈",
        wechatQrcodeHelper: '<p>扫码后点击右上角</p><p>将本文分享至朋友圈</p>'
      });
    </script>

  <!--  -->
  
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
  <script>
    const gitalk = new Gitalk({
      clientID: '67b57f65cc4d670a72ab',
      clientSecret: 'ec1ebc536274f62d4b9499d28bc7b3f2c018dca1',
      repo: 'luoren18.github.io',
      owner: 'luoren18',
      admin: 'luoren18',
      id: 'Spring Boot 集成 Spring Security',      // Ensure uniqueness and length less than 50
      distractionFreeMode: false,  // Facebook-like distraction free mode
      title: 'Spring Boot 集成 Spring Security'
    })
    gitalk.render('gitalk-container')
  </script>
  
  <script src="/assets/js/prism.js"></script>
  <script src="/assets/js/index.min.js"></script>
</body>

</html>